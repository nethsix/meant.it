<% require 'validators' %>
<% require 'controller_helper' %>

<%
  show_pii_these ||= []
  show_pii_force ||= false
  show_nick_force ||= false
  show_own_force ||= false
  # If not forced, the rules for display are:
  # - never shown if pii_hide is "true" (string not boolean)
  # - don't show pii unless pii_hide is "false"
  # - if we have not shown pii, then show nick, if it's not nil, otherwise show record number
  # - if we show nick, then show own
  src_pii_shown = false
  src_nick_shown = false
  dst_pii_shown = false
  dst_nick_shown = false
%>
<%
  src_creator_endPoint = nil
#20110630a  if !meant_it_rel.src_endpoint.nil? and !meant_it_rel.src_endpoint.nick.nil?
  if !meant_it_rel.src_endpoint.nil?
    src_creator_endPoint = EndPoint.find(meant_it_rel.src_endpoint.creator_endpoint_id)
  end
%>
<% 
  if !meant_it_rel.src_endpoint.nil? and !meant_it_rel.src_endpoint.pii.nil? and (meant_it_rel.src_endpoint.pii.pii_hide == "false" or show_pii_force or !show_pii_these.index(meant_it_rel.src_endpoint.pii.pii_value).nil? )
    src_pii_shown = true
%>
  <%= link_to "[pii:#{meant_it_rel.src_endpoint.pii.pii_value}]", "#{show_by_pii_value_piis_url}?#{Constants::PII_VALUE_INPUT}=#{URI::encode(meant_it_rel.src_endpoint.pii.pii_value)}" %>
<% end %>
<% 
  if !meant_it_rel.src_endpoint.nil? and (show_nick_force or !src_pii_shown)
    src_nick_shown = true
    if !meant_it_rel.src_endpoint.nick.nil?
%>
    <%= link_to "nick:#{meant_it_rel.src_endpoint.nick}", "#{show_by_nick_and_creator_endpoint_id_end_points_url}?#{Constants::END_POINT_NICK_INPUT}=#{URI::encode(meant_it_rel.src_endpoint.nick)}&#{Constants::END_POINT_CREATOR_END_POINT_INPUT}=#{meant_it_rel.src_endpoint.creator_endpoint_id}" %>
<%
    else
%>
    <%= link_to "id:#{meant_it_rel.src_endpoint.id}", "/end_points/show_by_id/#{meant_it_rel.src_endpoint.id}" %>
<% 
    end 
  end
%>
<% if !src_creator_endPoint.nil? and src_nick_shown
     if !src_creator_endPoint.nick.nil?
%>
     <%= link_to "(own:#{src_creator_endPoint.nick})", "#{show_by_nick_and_creator_endpoint_id_end_points_url}?#{Constants::END_POINT_NICK_INPUT}=#{URI::encode(src_creator_endPoint.nick)}&#{Constants::END_POINT_CREATOR_END_POINT_INPUT}=#{meant_it_rel.src_endpoint.creator_endpoint_id}" %>
<% 
     else
%>
     <%= link_to "own:#{src_creator_endPoint.id}", end_point_path(src_creator_endPoint.id) %>
<% 
     end
  end
 %>

<%= meant_it_rel.message_type %> 
<%
  dst_creator_endPoint = nil
#20110630a  if !meant_it_rel.dst_endpoint.nil? and !meant_it_rel.dst_endpoint.nick.nil?
  if !meant_it_rel.dst_endpoint.nil?
    dst_creator_endPoint = EndPoint.find(meant_it_rel.dst_endpoint.creator_endpoint_id)
  end
%>
<% 
  if !meant_it_rel.dst_endpoint.nil? and !meant_it_rel.dst_endpoint.pii.nil? and (meant_it_rel.dst_endpoint.pii.pii_hide == "false" or show_pii_force or !show_pii_these.index(meant_it_rel.src_endpoint.pii.pii_value).nil?)
    dst_pii_shown = true
%>
  <%= link_to "[pii:#{meant_it_rel.dst_endpoint.pii.pii_value}]", "#{show_by_pii_value_piis_url}?#{Constants::PII_VALUE_INPUT}=#{URI::encode(meant_it_rel.dst_endpoint.pii.pii_value)}" %>
<% end %>
<% 
  if !meant_it_rel.dst_endpoint.nil? and (show_nick_force or !dst_pii_shown)
    dst_nick_shown = true
    if !meant_it_rel.dst_endpoint.nick.nil?
%>
    <%= link_to "nick:#{meant_it_rel.dst_endpoint.nick}", "#{show_by_nick_and_creator_endpoint_id_end_points_url}?#{Constants::END_POINT_NICK_INPUT}=#{URI::encode(meant_it_rel.dst_endpoint.nick)}&#{Constants::END_POINT_CREATOR_END_POINT_INPUT}=#{meant_it_rel.dst_endpoint.creator_endpoint_id}" %>
<%
    else
%>
    <%= link_to "id:#{meant_it_rel.dst_endpoint.id}", "/end_points/show_by_id/#{meant_it_rel.dst_endpoint.id}" %>
<% 
    end 
  end
%>
<% if !dst_creator_endPoint.nil? and dst_nick_shown
     if !dst_creator_endPoint.nick.nil?
%>
     <%= link_to "(own:#{dst_creator_endPoint.nick})", "#{show_by_nick_and_creator_endpoint_id_end_points_url}?#{Constants::END_POINT_NICK_INPUT}=#{URI::encode(dst_creator_endPoint.nick)}&#{Constants::END_POINT_CREATOR_END_POINT_INPUT}=#{meant_it_rel.dst_endpoint.creator_endpoint_id}" %>
<% 
     else
%>
     <%= link_to "own:#{dst_creator_endPoint.id}", end_point_path(dst_creator_endPoint.id) %>
<% 
     end
  end
%>

<%= ControllerHelper.random_say %> '<i><%= meant_it_rel.message %></i>'
