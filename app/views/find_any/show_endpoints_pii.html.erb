<% require 'validators' %>
<% require 'constants' %>
<p id="notice"><%= notice %></p>
<%
  pii_endPoints = pii.endPoints
  pii_endPoints_srcMeantItRels = ControllerHelper.mir_from_ep_srcMeantItRels(pii_endPoints)

  endPoints_srcMeantItRels = ControllerHelper.mir_from_ep_srcMeantItRels(endPoints)

  # pii_endPoints to endPoints relationship
  pii_ep_mir_ep_arr = ControllerHelper.mir_from_find_match_dstEndPoints(pii_endPoints_srcMeantItRels, endPoints)
  pii_ep_mir_ep_msg_uniq_hash = ControllerHelper.mir_from_mir_uniqSrcMsgDstEndPoints(pii_ep_mir_ep_arr)

  # endPoints to pii_endPoints relationship
  ep_mir_pii_ep_arr = ControllerHelper.mir_from_find_match_dstEndPoints(endPoints_srcMeantItRels, pii_endPoints)
  ep_mir_pii_ep_msg_uniq_hash = ControllerHelper.mir_from_mir_uniqSrcMsgDstEndPoints(ep_mir_pii_ep_arr)

%>
<p>
<strong>Meant.It:</strong>
[pii:<%= pii.pii_value  %>] <=>
nick:<%= endPoints[0].nick %>]
</p>
<table summary="Meant.It Table"  border="0" cellspacing="0" cellpadding="0">
  <caption><em>Meant.It '[pii:<%= pii.pii_value %>] => nick:<%= endPoints[0].nick %>'</em></caption>
  <thead>
    <tr>
      <th class='span-8'>Sender Nick</th>
      <th class='span-4'>Message Type</th>
      <th class='span-8'>Receiver Nick</th>
      <th class='span-2'>Count</th>
      <th class='span-2'>Value</th>
    </tr>
  </thead>
  <tbody>
<% pii_ep_mir_ep_msg_uniq_hash.each { |hash_key, mir_arr| %>
    <tr>
      <td>
        <% # Just take any elem since they all have same source dest %>
        <%= render :partial => "shared/end_point_nick_col", :collection => [mir_arr[0].src_endpoint], :locals => { :show_nick_force => true } %>
      </td>
      <td>
        <%= mir_arr[0].message_type %>
      </td>
      <td>
        <% # Just take any elem since they all have same source dest %>
        <%= render :partial => "shared/end_point_nick_col", :collection => [mir_arr[0].dst_endpoint], :locals => { :show_nick_force => true } %>
      </td>
      <td>
        <%= mir_arr.size %>
      </td>
      <td>
        Coming..
      </td>
    </tr>
<% } %>
  </tbody>
</table>
<% if pii_ep_mir_ep_msg_uniq_hash.empty? %>
<p>
Nothing yet... <b>Don't be disheartened.  They'll come!</b>
</p>
<% else %>
<p>
Last <%= Constants::WEB_MAX_MEANTIT_IN %> Meant.It In '[pii:<%= pii.pii_value %>] => nick:<%= endPoints[0].nick %>'<br/>
<%
  lastXs2rMeantItRels= MeantItRel.where(:src_endpoint_id => pii_endPoints, :dst_endpoint_id => endPoints).order("created_at DESC").limit(Constants::WEB_MAX_MEANTIT_IN)
%>
  <% if !lastXs2rMeantItRels.nil? and !lastXs2rMeantItRels.empty? %>
    <ul><li>
  <% end %>
    <%= render :partial => "shared/meant_it_rel", :spacer_template => "shared/li_ruler", :collection => lastXs2rMeantItRels %>
  <% if !lastXs2rMeantItRels.nil? and !lastXs2rMeantItRels.empty? %>
    </li></ul>
  <% end %>
</p>
<% end %>

<table summary="Meant.It Table"  border="0" cellspacing="0" cellpadding="0">
  <caption><em>Meant.It 'nick:[<%= endPoints[0].nick %> => [pii:<%= pii.pii_value %>]'</em></caption>
  <thead>
    <tr>
      <th class='span-8'>Sender Nick</th>
      <th class='span-4'>Message Type</th>
      <th class='span-8'>Receiver Nick</th>
      <th class='span-2'>Count</th>
      <th class='span-2'>Value</th>
    </tr>
  </thead>
  <tbody>
<% ep_mir_pii_ep_msg_uniq_hash.each { |hash_key, mir_arr| %>
    <tr>
      <td>
        <% # Just take any elem since they all have same source dest %>
        <%= render :partial => "shared/end_point_nick_col", :collection => [mir_arr[0].src_endpoint], :locals => { :show_nick_force => true } %>
      </td>
      <td>
        <%= mir_arr[0].message_type %>
      </td>
      <td>
        <% # Just take any elem since they all have same source dest %>
        <%= render :partial => "shared/end_point_nick_col", :collection => [mir_arr[0].dst_endpoint], :locals => { :show_nick_force => true } %>
      </td>
      <td>
        <%= mir_arr.size %>
      </td>
      <td>
        Coming..
      </td>
    </tr>
<% } %>
  </tbody>
</table>
<% if ep_mir_pii_ep_msg_uniq_hash.empty? %>
<p>
Nothing yet... <b>Don't be disheartened.  They'll come!</b>
</p>
<% else %>
<p>
Last <%= Constants::WEB_MAX_MEANTIT_IN %> Meant.It In 'nick:<%= endPoints[0].nick %> => [pii:<%= pii.pii_value %>]'<br/>
<%
  lastXr2sMeantItRels= MeantItRel.where(:src_endpoint_id => endPoints, :dst_endpoint_id => pii_endPoints).order("created_at DESC").limit(Constants::WEB_MAX_MEANTIT_IN)
%>
  <% if !lastXr2sMeantItRels.nil? and !lastXr2sMeantItRels.empty? %>
    <ul><li>
  <% end %>
    <%= render :partial => "shared/meant_it_rel", :spacer_template => "shared/li_ruler", :collection => lastXr2sMeantItRels %>
  <% if !lastXr2sMeantItRels.nil? and !lastXr2sMeantItRels.empty? %>
    </li></ul>
  <% end %>
</p>
<% end %>
